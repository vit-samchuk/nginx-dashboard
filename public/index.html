<!DOCTYPE html>
<html lang="en" x-data="dashboardApp" class="sl-theme-dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NGINX Dashboard</title>
  
  <!-- Eruda -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    eruda.init();
  </script>
  
  <!-- Shoelace UI -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.0/cdn/shoelace.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/dark.css" />
  <!-- Reset -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  
  <!-- ACE Editor CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/mode-nginx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/theme-monokai.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.31.1/ext-language_tools.min.js"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="./style.css" />
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  
</head>

<body>
  
  <!-- Header -->
  <header>
    <h2>NGINX</h2>
    <sl-icon-button :name="!guest ? 'person-check-fill' : 'person-x-fill'" label="Login" @click="auth()"></sl-icon-button>
  </header>
  
  <!-- Main -->
  <main class="container">
    <section>
      <div class="header-row">
        <h3>Configs</h3>
        <sl-button size="small" variant="primary" @click="newConfig()">New Config</sl-button>
      </div>
      
      
      <!-- Show loading state -->
      <div x-show="configs.loading" class="loading-message">
        ‚è≥ Loading configurations...
      </div>
      
      <!-- Show error if config list failed to load -->
      <div x-show="configs.err && !configs.loading" class="error-message">
        ‚ùå Failed to load configuration list
      </div>
      
      <!-- Show message if there are no configs and no error -->
      <div x-show="!configs.err && !configs.loading && configs.list.length === 0" class="empty-message">
        üóÇÔ∏è No configurations found
      </div>
      
      <!-- Show config list -->
      <template x-if="!configs.err && !configs.loading && configs.list.length > 0">
        <div style="padding: 0 0 150px;">
          <template x-for="config in configs.list.sort((a, b) => b.enabled - a.enabled)" :key="config.id">
            <div :class="configs.active.includes(config.id) ? 'config config-wrap' : 'config'">
              <div class="config-item" :class="config.enabled ? '' : 'disabled'" @click="configClick(config.id)">
                <span x-text="config.path.split('/').at(-1)"></span>
                <div x-show="config.validation_status === 'invalid'" class="status inwalid">
                  <sl-icon name="exclamation-diamond"></sl-icon>
                </div>
                <div x-show="config.validation_status === 'unknown'" class="status unknown">
                  <sl-icon name="question-diamond"></sl-icon>
                </div>
              </div>
              <div x-show="configs.active.includes(config.id)">
                <p class="path" x-text="config.path"></p>
                <p class="time" x-text="(new Date(config.last_modified)).toLocaleString()"></p>
                <p class="error" x-show="config.validation_status === 'invalid'" x-text="config.validation_error"></p>
                <div class="buttons">
                  <sl-icon-button name="pencil" label="Edit" @click="editConfig(config)" style="font-size: 20px; color: green;"></sl-icon-button>
                  <sl-switch :checked="config.enabled" @sl-change="toggle($event.target, config)"
                    style="--width: 40px; --height: 20px; --thumb-size: 16px;"></sl-switch>
                  
                  <sl-icon-button name="trash-fill" label="Delete" @click="deleteConfig(config)" style="font-size: 20px; color: red;"></sl-icon-button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>
    </section>
    
    <!-- ### EDITOR ### -->
    <div :class="editor.visible ? 'editor-wrap' : 'editor-wrap hidden'">
      <div class="editor_header">
        <p x-show="!!editor.cfg" class="title" x-text="editor.cfg?.path"></p>
        <p x-show="!editor.cfg" class="title">
          <sl-input :value="editor.name" @sl-input="editor.name = $event.target.value" placeholder="domain.com" size="small">
            <span class="prefix" slot="prefix">Config name:</span>
          </sl-input>
        </p>
        <p class="error" x-show="editor.cfg?.validation_status === 'invalid'" x-text="editor.cfg?.validation_error"></p>
      </div>
      <div class="editor" id="editor"></div>
      <div class="editor_footer">
        <div class="toolbar">
          <sl-button size="small" pill variant="default" style="opacity: 0.8;" @click="insertTab(); $event.target.blur()" tabindex="-1">Tab</sl-button>
          <sl-button size="small" pill variant="default" style="opacity: 0.8;" @click="format(); $event.target.blur()" tabindex="-1">F</sl-button>
          <sl-button size="small" pill variant="default" style="opacity: 0.8;" @click="insertPair('{}'); $event.preventDefault()" tabindex="-1">{}</sl-button>
          <sl-button size="small" pill variant="default" style="opacity: 0.8;" @click="insertPair('[]'); $event.preventDefault()" tabindex="-1">[]</sl-button>
          <sl-button size="small" pill variant="default" style="opacity: 0.8;" @click="insertPair('&quot;&quot;'); $event.preventDefault()"
            tabindex="-1">""</sl-button>
          <sl-button size="small" pill variant="default" style="opacity: 0.8;" @click="toggleComment(); $event.preventDefault()" tabindex="-1">#</sl-button>
        </div>
        
        <div class="buttons">
          <sl-button @click='saveConfig()' variant="primary">Save</sl-button>
          <sl-button x-show="!editor.cfg" @click='saveAndEnableConfig()' variant="success">Save & Enable</sl-button>
          <sl-button @click='closeEditor()' variant="danger">Close</sl-button>
        </div>
        <div x-show="!!editor.cfg" :class="editor.cfg?.enabled ? 'status enabled' : 'status disabled'"
          x-text="editor.cfg?.enabled ? 'Config enabled' : 'Not enabled'"></div>
      </div>
    </div>
  </main>
  
  <!-- Editor Confirm Modal -->
  <sl-dialog id="editorConfirmModal" label="Unsaved data">
    You have unsaved data. Do you want to close editor?
    <div slot="footer" style="display: flex; gap: 10px; justify-content: end">
      <sl-button slot="footer" variant="primary" @click="closeEditor(true)">Close</sl-button>
      <sl-button slot="footer" variant="danger" @click="closeConfirmModal()">Cancel</sl-button>
    </div>
  </sl-dialog>
  
  <!-- Login Modal -->
  <sl-dialog id="loginModal" label="Login">
    <sl-input placeholder="Username" x-model="login.username"></sl-input>
    <sl-input type="password" placeholder="Password" x-model="login.password" password-toggle></sl-input>
    <div>
      <sl-button variant="primary" @click="doLogin()">Login</sl-button>
    </div>
  </sl-dialog>
  
  <!-- Alpine app logic -->
  <script>
    if ('virtualKeyboard' in navigator) navigator.virtualKeyboard.overlaysContent = true;
    const URL = "https://nginx-dashboard.do-code.com";
    
    const _fetch = async (path, options = {}) => {
      console.log(path, options)
      //if (path !== '/configs/list') return 'ok';
      try {
        const res = await fetch(`${URL}${path}`, options);
        
        if (res.status === 401 && path !== '/auth/me') {
          errorToast('Permission denied! Guests are not allowed to do this action.')
          logoutUser();
        }
        
        if (!res.ok) {
          const text = await res.text().catch(() => '');
          throw new Error(`Error ${res.status}: ${text || res.statusText}`);
        }
        
        return res.json();
      } catch (err) {
        console.error('Request error:', err);
        throw err;
      }
    };
    
    const _post = (path, data) =>
      _fetch(path, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
    
    const _delete = (path) => _fetch(path, { method: 'DELETE' });
    const toast = (message, variant = 'primary') => {
      const alert = Object.assign(document.createElement('sl-alert'), {
        variant,
        closable: true,
        duration: 4000,
        innerHTML: `<sl-icon slot="icon" name="info-circle"></sl-icon>${message}`,
      })
      
      document.body.appendChild(alert)
      alert.toast().then(() => { setTimeout(() => alert.remove(), 5000) })
    }
    const errorToast = (err) => {
      let message = 'Error! Something went wrong...';
      
      if (typeof err === 'string') {
        message = err;
      } else if (err && typeof err === 'object' && typeof err.message === 'string') {
        message = err.message;
      }
      
      return toast(message, 'danger');
    }
    const api = {
      login: (u, p) => _post('/auth/login', { username: u, password: p }),
      logout: () => _post('/auth/logout'),
      getCurrentUser: () => _fetch('/auth/me'),
      loadConfigs: () => _fetch('/configs/list'),
      getConfigById: (id) => _fetch(`/configs/id/${id}`),
      createConfig: (name, content) => _post('/configs/create', { name, content }),
      createAndEnableConfig: (name, content) => _post('/configs/create-and-enable', { name, content }),
      enableConfig: (id) => _post(`/configs/enable/${id}`),
      disableConfig: (id) => _post(`/configs/disable/${id}`),
      updateConfig: (id, content) => _post(`/configs/update/${id}`, { content }),
      deleteConfig: (id) => _delete(`/configs/${id}`),
      reloadNginx: () => _post('/configs/nginx-reload'),
    };
    
    const logoutUser = async () => {
      if (dashboardApp.guest) return;
      await api.logout()
      dashboardApp.guest = true;
    }
    
    const formatNginxConfig = (config) => {
      const lines = config.split('\n');
      let indentLevel = 0;
      const indentSize = 4;
      
      const formatted = lines.map(line => {
        const trimmed = line.trim();
        
        if (trimmed === '') return '';
        
        // –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø –¥–æ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –±–ª–æ–∫
        if (trimmed.startsWith('}')) indentLevel--;
        
        const indent = ' '.repeat(indentSize * indentLevel);
        const result = indent + trimmed;
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–ª–æ–∫
        if (trimmed.endsWith('{')) indentLevel++;
        
        return result;
      });
      
      return formatted.join('\n');
    }
    
    
    const dashboardApp = () => ({
      guest: true,
      configs: {
        loading: true,
        list: [],
        err: false,
        active: [],
      },
      editor: {
        item: null,
        cfg: null,
        name: '',
        visible: false,
      },
      currentId: null,
      login: { username: '', password: '' },
      loginModal: null,
      editorConfirmModal: null,
      
      async init() {
        this.editor.item = ace.edit("editor");
        this.editor.item.setTheme("ace/theme/monokai");
        this.editor.item.session.setMode("ace/mode/nginx");
        this.editor.item.setOptions({
          tabSize: 2,
          useSoftTabs: true,
          showPrintMargin: false,
          enableBasicAutocompletion: true,
          enableLiveAutocompletion: true,
          enableSnippets: true
        });
        try {
          const me = await api.getCurrentUser();
          console.log({ me })
          this.guest = false;
        } catch (err) {
          this.guest = true;
        }
        
        
        await this.loadConfigs();
        this.loginModal = document.getElementById("loginModal");
        this.editorConfirmModal = document.getElementById("editorConfirmModal");
        window.addEventListener('popstate', (event) => {
          if (event.state?.editorOpen || this.editor.visible) {
            this.closeEditor();
          }
        });
      },
      
      auth() {
        return this.guest ? this.showLogin() : this.showLogout()
      },
      
      configClick(id) {
        this.configs.active.includes(id) ?
          this.configs.active.splice(this.configs.active.indexOf(id), 1) :
          this.configs.active.push(id);
      },
      
      async loadConfigs() {
        try {
          this.configs.loading = true;
          const data = await api.loadConfigs();
          this.configs.list = data.list || []
          this.configs.err = false;
        } catch (err) {
          this.configs.list = []
          this.configs.err = true;
          errorToast(err)
        } finally {
          this.configs.loading = false;
        }
      },
      editConfig(cfg) {
        this.editor.cfg = cfg;
        this.editor.item.setValue(cfg.content, 1);
        this.showEditor();
      },
      showEditor() {
        this.editor.item.session.getUndoManager().markClean();
        history.pushState({ editorOpen: true }, '');
        this.editor.visible = true;
      },
      closeEditor(force = false) {
        if (force) {
          this.closeConfirmModal();
          this.hideEditor();
          return
        }
        const changed = !this.editor.item.session.getUndoManager().isClean();
        if (!changed) return this.hideEditor();
        if (!history.state?.editorOpen) history.pushState({ editorOpen: true }, '');
        this.editorConfirmModal.show()
      },
      closeConfirmModal() {
        this.editorConfirmModal.hide()
      },
      hideEditor() {
        this.editor.visible = false;
        this.editor.cfg = null;
        this.editor.item.setValue('', 1);
        this.editor.name = '';
        if (history.state?.editorOpen) history.back();
      },
      newConfig() {
        this.showEditor();
      },
      async saveConfig(enable = false) {
        const content = this.editor.item.getValue()
        
        if (!this.editor.cfg && !this.editor.name.length) {
          return errorToast('Config name not specified!')
        }
        
        const cfg = this.editor.cfg ? this.editor.cfg.id : this.editor.name;
        try {
          const res = await (this.editor.cfg ?
            api.updateConfig(cfg, content) :
            api.createConfig(cfg, content)
          )
          
          if (!res.config) return errorToast('Unknown error while creating config...')
          
          if (this.editor.cfg && this.editor.cfg.enabled && !res.config.enabled) {
            toast('Config saved but disabled! Check for errors...', 'warning')
          } else {
            toast('Config saved!', 'success')
          }
          this.configs.list = [
            ...this.configs.list.filter(cfg => cfg.id !== res.config.id),
            res.config
          ];
          this.hideEditor()
          this.editConfig(res.config)
          // this.editor.cfg = res.config;
        } catch (err) {
          errorToast(err)
        }
      },
      async saveAndEnableConfig() {
        const content = this.editor.item.getValue()
        
        try {
          const res = await api.createAndEnableConfig(this.editor.name, content)
          if (!res.config) return errorToast()
          this.configs.list.push(res.config)
          if (!res.config.enabled) {
            toast('Config created but not enabled! Check for errors...', 'warning')
          } else {
            toast('Config created and enabled!', 'success')
          }
          this.hideEditor();
          this.editConfig(res.config)
        } catch (err) {
          toast(err);
        }
      },
      
      async toggle(el, config) {
        const enable = el.checked;
        
        el.disabled = true;
        try {
          await (enable ?
            api.enableConfig(config.id) :
            api.disableConfig(config.id));
          
          await this.loadConfigs();
        } catch (err) {
          toast(err)
          el.checked = !enable;
        } finally {
          el.disabled = false;
        }
      },
      
      async deleteConfig(cfg) {
        try {
          await api.deleteConfig(cfg.id);
          await this.loadConfigs();
        } catch (err) {
          errorToast(err)
        }
      },
      
      showLogin() { this.loginModal.show() },
      
      async showLogout() {
        // todo: actually show logout modal
        await api.logout()
        this.guest = true;
      },
      
      async doLogin() {
        try {
          await api.login(this.login.username, this.login.password)
          this.loginModal.hide();
          this.guest = false;
          toast('Authorization success')
        } catch (err) {
          this.guest = true;
          errorToast(err)
        }
      },
      format() {
        const raw = this.editor.item.getValue();
        const formatted = formatNginxConfig(raw);
        this.editor.item.setValue(formatted, 1)
        this.editor.item.focus()
      },
      insertTab() {
        this.editor.item.insert('\t')
        this.editor.item.focus()
      },
      insertPair(pair) {
        const [open, close] = pair.split('');
        this.editor.item.insert(open + close);
        this.editor.item.navigateLeft(1);
        this.editor.item.focus()
      },
      toggleComment() {
        const editor = this.editor.item;
        const session = editor.getSession();
        const selection = editor.getSelectionRange();
        const lines = [];
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏
        for (let row = selection.start.row; row <= selection.end.row; row++) {
          lines.push(session.getLine(row));
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Å—Ç—Ä–æ–∫–∏ —É–∂–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
        const allCommented = lines.every(line => line.trim().startsWith('#'));
        
        for (let row = selection.start.row; row <= selection.end.row; row++) {
          const line = session.getLine(row);
          if (allCommented) {
            // –£–±–∏—Ä–∞–µ–º # (—Ä–∞—Å—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º)
            const uncommented = line.replace(/^(\s*)#\s?/, '$1');
            session.replace({
              start: { row, column: 0 },
              end: { row, column: line.length }
            }, uncommented);
          } else {
            // –î–æ–±–∞–≤–ª—è–µ–º # (–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º)
            session.replace({
              start: { row, column: 0 },
              end: { row, column: 0 }
            }, '# ');
          }
        }
        this.editor.item.focus()
      }
      
      
    });
  </script>
</body>

</html>